@(title: String)(content: Html)

<!DOCTYPE html>

<html lang="es" ng-app="vestaroMain">
  <head>
    <title>@title</title>
    <meta content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="krea group">

    <!-- Fav icons -->
    <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">      

    <!-- Basic 3rd parties libraries -->
    <script src="@routes.Assets.at("lib/jQuery/2.0.3/jquery-2.0.3.min.js")" type="text/javascript"></script> 
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("lib/jQuery/2.0.3/jquery-ui.css")"> <!-- jquery shuld be load before angular, so angular uses it instead of jqLite. jQuery suppoprt <script> tag which jqLite doesn't. https://github.com/angular/angular.js/issues/369 -->

    <script src="@routes.Assets.at("lib/angularjs/1.1.5/angular.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("lib/angularjs/1.1.5/angular-resource.min.js")" type="text/javascript"></script>

    <script src="@routes.Assets.at("lib/bootstrap/3.0.0/js/bootstrap.min.js")" type="text/javascript"></script>
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("lib/bootstrap/3.0.0/css/bootstrap.min.css")">

    <script src="@routes.Assets.at("lib/easyrec-jsApi/easyrec-jsApi-v0.98.js")" type="text/javascript"></script>
    
    <!-- App's Stylesheets -->
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("css/main.css")">

    <!-- App's Javascripts -->
    <script src='@routes.Application.javascriptRoutes()' type="text/javascript"></script>
    <script src="@routes.Assets.at("js/app.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("js/routingNavigation.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("js/buyerControllers.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("js/controllers.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("js/filters.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("js/directives.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("js/easyrec.js")" type="text/javascript"></script>

    <!-- Selective 3rd parties libraries -->
    <script src="@routes.Assets.at("lib/jQuery-plugins/jquery.isotope.min.js")" type="text/javascript"></script>

    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
      <![endif]-->
  </head>
  <body>
    <div id="fb-root"></div>
    <!-- FACEBOOK AUTH, se tiene que cargar lo mas rapido posible por eso esta antes en el body-->
    <script>
        var authData = {};
        window.fbAsyncInit = function() {
          FB.init({
            appId      : '613594491995651', // App id
            channelUrl : '//localhost:9000/assets/html/authentication/channel.html', // Channel File
            status     : false, // check login status. HACK: Disable to avoid double login when user is logged into fb and app authorized.
            cookie     : true, // enable cookies to allow the server to access the session
            xfbml      : true  // parse XFBML
          });

          // Subscribe to the auth.authResponseChange JavaScript event. This event is fired
          // for any authentication related change, such as login, logout or session refresh. This means that
          // whenever someone who was previously logged out tries to log in again, the correct case below 
          // will be handled. 
          console.log('subscribing to the auth.authResponseChange JavaScript event...');
          FB.VestaroData = {selectedAccountUsage: null, registrationMode: false};
          FB.Event.subscribe('auth.authResponseChange', function(response) {
            if (response.status === 'connected') {
              authData.signedRequest = response.authResponse.signedRequest;
              if (!authData.fbUser) {
                authData.fbUser = {};
                authData.fbUser.id = response.authResponse.userID;
              }
              console.log('Event detected: User connected & app accepted. Fetching your information.... ');

              // If login was trigger by registration button...
              if(FB.VestaroData.registrationMode)
              {
                // ...ask to the user for the main account's usage.
                console.log('RegistrationMode On: asking for account main usage.');
                $('#remoteModal').modal({remote: '/assets/html/authentication/registrationModalBuyerSelleChoice.html'})
              } else {
                // ...skip to vestaro login directly.
                AuthenticateVestaro();
              }

              // Load user's profile picture
              $('.navbar .nav .currentUserImg')
                .load(function () {
                  $(this).show();
                })
                .error(function () {
                  console.log("user's profile image could not be loaded.");
                })
                .attr('src','http://graph.facebook.com/'+response.authResponse.userID+'/picture')
              
              // Load user's name
              FB.api('/me', function(response) {
                $('.navbar .nav .currentUsername').text(response.name).show();
                console.log('Good to see you, ' + response.name + '.');
                authData.fbUser = response;
                if (FB.VestaroData.registrationMode)
                {
                  console.log('RegistrationMode On: sending username to vestaro.');
                  SendUserName(response.name);
                }
              });      

              // display ui
              $('#fbSignIn').hide();
              $('.navbar .connectingWithFbLabel').hide();
              $('.navbar .loggedUserOptions').fadeIn();

              //If app is not allow, aparently callbackfunction is never call. 
              //} else if (response.status === 'not_authorized') {
              //  // In this case, the person is logged into Facebook, but not into the app, so we call
              //  // FB.login() to prompt them to do so. 
              //  // In real-life usage, you wouldn't want to immediately prompt someone to login 
              //  // like this, for two reasons:
              //  // (1) JavaScript created popup windows are blocked by most browsers unless they 
              //  // result from direct interaction from people using the app (such as a mouse click)
              //  // (2) it is a bad experience to be continually prompted to login upon page load.
              //  console.log('not_authorized event detectec.');
            } else {
              // Person is not logged into Facebook. At this stage there is no indication
              // of whether they are logged into the app. If they aren't then they'll see the Login
              // dialog right after they log in to Facebook. 
              console.log('Event detected: User not logged to FB.');
            }
          });

          console.log("getting FB's LoginStatus...");
          // LOGIN CHECK: As check login status was set to false, initial login check has to be manually triggered.
          FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
              console.log("FB's LoginStatus answered logged as user " + response.authResponse.userID + '.');
              // In case user is logged, no action has to be taken as it would be automatically triggered becuase sdk subscribed to auth.authResponseChange JavaScript event.
            }else{
              console.log('getLoginStatus answered not logged. Loading logIn optionsd...');
                // FB.login();
                // Show Ui to log in.
                $('#fbSignIn').show();
            }
          },function(error){
            console.log("FB's LoginStatus answered with an error: " + error);
            // TODO: send error to server error log.
          });
        };

        // Load the SDK asynchronously
        (function(d){
         var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement('script'); js.id = id; js.async = true;
         js.src = "//connect.facebook.net/en_US/all.js";
         ref.parentNode.insertBefore(js, ref);
       }(document));

      function AuthenticateVestaro(selectedAccountUsage){
        $.post("@routes.Authentication.login()", 
          {signedRequest: authData.signedRequest, accountUsage: selectedAccountUsage})
          .done(function(data) {
            console.log("Auth to vestaro successful. Data: " + JSON.stringify(data));
            FB.VestaroData.registrationMode = false;
            if (data.userRoles.length == 0)
            {
              $('#remoteModal').modal({remote: '/assets/html/authentication/registrationModalBuyerSelleChoice.html'})
            } 
            if (data.requestUserName){
              console.log("Auth to vestaro request username: ");
              var usernameLocalCopy = $('.navbar .nav .currentUsername').text();
              if (usernameLocalCopy != "")
              {
                console.log("Local copy available, sending it.");
                SendUserName(usernameLocalCopy);
              } else {
                console.log("No Local copy available, requesting data to Fb and sending it.");
                FB.api('/me', function(response) {
                    SendUserName(response.name);
                  });
              };
            }
          });

              //TODO: Load nav's user opts
        };

      function SendUserName(username){
        $.post("@routes.Authentication.()", {fbName: username})
      };
    </script>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation" style="min-height: 0px;">
      <div class="container">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
          <span class="sr-only">Toggle navigation</span> 
          <span class="icon-bar"></span> 
          <span class="icon-bar"></span> 
          <span class="icon-bar"></span>
        </button>
        <a class="vestaro-logo navbar-brand" style="padding-bottom: 0px; padding-top: 8px; color: #2974B9; font-size: 36px;">Vestaro</a>
      </div>

      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul ng-controller="NavCtrl" class="nav navbar-nav">
          <li ng-repeat="view in views" ng-class="{active: isActive(view)}">
            <a style="padding-bottom: 10px; padding-top: 10px;" href="#{{view.path}}">
              <span class="glyphicon glyphicon-{{view.icon}}"></span> {{view.title}}
            </a>
          </li>
        </ul>
        <ul class="nav navbar-nav navbar-right loggedUserOptions" style="display: none;">
          <li>
            <a style="padding: 9px 15px 6px;">
              <img src="" class="currentUserImg" style="display: none; height: 23px; width: 23px; border: 1px solid #ccc;"> 
              <span class="currentUsername" style="display: none;"></span>
            </a>
          </li>
          <li class="dropdown">
            <a style="padding-bottom: 10px; padding-top: 10px;" class="dropdown-toggle" data-toggle="dropdown">Comprador 
              <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Usar Vestaro como:</li>
              <li class="divider"></li>
              <li>
                <a>
                  <span class="glyphicon glyphicon-ok pull-right"></span>Comprador
                </a>
              </li>
              <li>
                <a>Vendedor</a>
              </li>
              <li class="divider"></li>
              <li>
                <a onclick="FB.logout(function(response) {$('.navbar .loggedUserOptions').fadeOut();});">Salir</a>
              </li>
            </ul>
          </li>
        </ul>

        <div ng-include="'@routes.Assets.at("html/loginNavbar.html")'"></div>
      </div>
        <!-- /.navbar-collapse -->
    </div>
    </nav>
    <!-- /container -->
    <div id="main" class="container">
        <div ng-view></div>
    </div> 
    <!-- /.container -->
    <!-- Remote Modal's div -->
    <div class="modal fade" id="remoteModal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    </div><!-- /.Remote Modal's div -->

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="https://www.mercadopago.com/org-img/jsapi/mptools/buttons/render.js"></script>
  </body>
</html>
