@(orders : List[BuyOrder]) @import helper._

<div >
<div class="col-lg-8">
	<legend>
		<h2>Órdenes de compra</h2>
	</legend>

	<div class="panel-group" id="accordion">
		@for(buyOrder <- orders ){
		<div class="panel panel-default">
			<div class="panel-heading">
				<h4 class="panel-title">
					<a class="accordion-toggle collapsed" data-toggle="collapse"  data-parent="#accordion" href="#@buyOrder.id"> <strong>
							@buyOrder.item.title</strong> <span class="badge active pull-right @buyOrder.state">@buyOrder.state.getDescription()</span>
					</a>
				</h4>
			</div>
			<div id=@buyOrder.id class="panel-collapse collapse in">
				<div class="panel-body">
					<div class="col-lg-3">
						<img src=@buyOrder.item.imgUrl style="width: 80%;">
					</div>
					<div class="col-lg-6">
						<p>Descripción: @buyOrder.item.description</p>
						<p>Talle: @buyOrder.size.size</p>
						<p>Precio: $@buyOrder.price</p>
					</div>
					<div class="col-lg-3">
						@if(buyOrder.state.getDescription() != "Recepción confirmada"){
						<button type="button" id="actionButton" data-loading-text="Cambiando estado..."	 onClick= "@buyOrder.state.getAction(buyOrder.id);" class="btn btn-primary">@buyOrder.state.getActionMessage()</button>
						@if(buyOrder.state.getDescription() == "Pendiente de recepción"){
						<button type="button"  id="disputeButton" onclick="showDisputeModal(@buyOrder.id);" class="btn btn-default" style="margin-top: 15px;">Abrir disputa</button>

						} }
					</div>
				</div>
			</div>
		</div>
		}

	</div>
	
	
	
	
	
	
</div>	

@disputeModal()

</div>
<script>
	$(document).ready(function() {
	
		$('.collapse').collapse('hide');
	
	});


	function showDisputeModal(buyOrder){
	 	$('#save').click(
	 		function(){
	 				openDispute(buyOrder);
	 				}
	 				);
		$('#disputeModal').modal('show');
	}

	function openDispute(buyOrder){
	
	var disputeMessage = $('#disputeMessage').get(0).value;
	jsRoutes.controllers.BuyerController.openDispute(buyOrder, disputeMessage).ajax(
			{
				success:function(json){
						$('#disputeModal').modal('hide');
						changeToInDispute(buyOrder);
					
				}
			}
		);
	}

	function confirmReception(buyOrder){
		$(actionButton(buyOrder)).button('loading');
		jsRoutes.controllers.BuyerController.confirmReception(buyOrder).ajax(
			{
				success:function(){
					changeToReceptionConfirmed(buyOrder);
				}
			}
		);
	}
	function changeToInDispute(buyOrder){
					//Change state text and colo r+ delete open dispute button
					changeState(buyOrder, 'En disputa', 'IN_DISPUTE','disputeButton' );
									
	}
	
	function changeToReceptionConfirmed(buyOrder){
					//Change state text and colo r+ delete button
					changeState(buyOrder, 'Recepción confirmada','RECEPTION_CONFIRMED' , 'actionButton');
					
	}
	
	function changeState(buyOrder, stateMessage, stateClass, deletedButton){
			var title=$($('#'+buyOrder).parent()).find('span');
					$(title).text(stateMessage)
					$(title).attr('class', 'badge active pull-right '+ stateClass)
					var button = $('#' + buyOrder).find('#'+deletedButton);
					$(button).fadeOut('normal', function(){
									$(this).remove();
						});
	
	}	

	function actionButton(buyOrder){
		 return orderButton(buyOrder,'actionButton');
	}
	

	function disputeButton(buyOrder){
		return orderButton(buyOrder,'disputeButton');
	}
	
	function orderButton(buyOrder, buttonId){
		return $('#' + buyOrder).find('#'+buttonId);
	}
	
</script>

<style>
.PAYMENT_PENDING {
	background-color: rgb(153, 134, 202);
}

.RECEPTION_PENDING {
	background-color: rgb(100, 164, 233);
}

.RECEPTION_CONFIRMED {
	background-color: rgb(55, 197, 72);
}

.IN_DISPUTE {
	background-color: rgb(240, 77, 77);;
}
</style>